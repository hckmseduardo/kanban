# Team Instance Docker Compose
# This file is used by the orchestrator to deploy individual team environments
# Uses shared images (kanban-team-api:latest, kanban-team-web:latest) built once for all teams

services:
  api:
    image: kanban-team-api:latest
    environment:
      - TEAM_SLUG=${TEAM_SLUG}
      - DOMAIN=${DOMAIN}
      - DATA_DIR=/app/data
      # Email configuration
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-office365}
      - SMTP_HOST=${SMTP_HOST:-smtp.office365.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - EMAIL_FROM_EMAIL=${EMAIL_FROM_EMAIL}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-Kanban}
    volumes:
      - ${DATA_PATH}:/app/data
    networks:
      - kanban-global
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${TEAM_SLUG}-api.rule=Host(`${TEAM_SLUG}.${DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.${TEAM_SLUG}-api.entrypoints=websecure"
      - "traefik.http.routers.${TEAM_SLUG}-api.tls=true"
      - "traefik.http.routers.${TEAM_SLUG}-api.middlewares=${TEAM_SLUG}-api-strip"
      - "traefik.http.middlewares.${TEAM_SLUG}-api-strip.stripprefix.prefixes=/api"
      - "traefik.http.services.${TEAM_SLUG}-api.loadbalancer.server.port=8000"
    restart: unless-stopped

  web:
    image: kanban-team-web:latest
    networks:
      - kanban-global
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${TEAM_SLUG}-web.rule=Host(`${TEAM_SLUG}.${DOMAIN}`) && !PathPrefix(`/api`)"
      - "traefik.http.routers.${TEAM_SLUG}-web.entrypoints=websecure"
      - "traefik.http.routers.${TEAM_SLUG}-web.tls=true"
      - "traefik.http.services.${TEAM_SLUG}-web.loadbalancer.server.port=80"
    restart: unless-stopped

networks:
  kanban-global:
    external: true
