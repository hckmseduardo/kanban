# =============================================================================
# Kanban Platform - Docker Compose Configuration
# =============================================================================
# Usage:
#   ./start.sh              # Start with default port 3001
#   ./start.sh 8080         # Start with custom port
#   docker compose down     # Stop all services
# =============================================================================

services:
  # ===========================================================================
  # Reverse Proxy & Load Balancer
  # ===========================================================================
  traefik:
    image: traefik:v3.0
    container_name: kanban-traefik
    restart: unless-stopped
    expose:
      - "80"
      - "443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - ./traefik/certs:/etc/traefik/certs
    environment:
      - DOMAIN=${DOMAIN:-localhost}
    networks:
      - kanban-global
      - proxy-network
    labels:
      - "traefik.enable=true"
    depends_on:
      - redis

  # ===========================================================================
  # Message Queue
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: kanban-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - kanban-global
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # Portal Backend API
  # ===========================================================================
  portal-api:
    build:
      context: ./portal/backend
      dockerfile: Dockerfile
    container_name: kanban-portal-api
    restart: unless-stopped
    environment:
      - REDIS_URL=redis://redis:6379
      - DOMAIN=${DOMAIN:-localhost}
      - PORT=${PORT:-4443}
      - CERT_MODE=${CERT_MODE:-development}
      - AZURE_KEY_VAULT_URL=${AZURE_KEY_VAULT_URL}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - ENTRA_CLIENT_ID=${ENTRA_CLIENT_ID}
      - ENTRA_CLIENT_SECRET=${ENTRA_CLIENT_SECRET}
      - ENTRA_TENANT_ID=${ENTRA_TENANT_ID}
      - PORTAL_SECRET_KEY=${PORTAL_SECRET_KEY:-dev-secret-change-me}
      - CROSS_DOMAIN_SECRET=${CROSS_DOMAIN_SECRET:-dev-cross-domain-secret}
    volumes:
      - ./portal/backend/app:/app/app
      - ./data/portal:/app/data
    networks:
      - kanban-global
    labels:
      - "traefik.enable=true"
      # HTTPS router
      - "traefik.http.routers.portal-api.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.portal-api.entrypoints=websecure"
      - "traefik.http.routers.portal-api.tls=true"
      - "traefik.http.routers.portal-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.portal-api.middlewares=portal-api-strip"
      - "traefik.http.middlewares.portal-api-strip.stripprefix.prefixes=/api"
      - "traefik.http.services.portal-api.loadbalancer.server.port=8000"
      # HTTP router (redirect to HTTPS)
      - "traefik.http.routers.portal-api-http.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.portal-api-http.entrypoints=web"
      - "traefik.http.routers.portal-api-http.middlewares=redirect-to-https@file"
    depends_on:
      redis:
        condition: service_healthy

  # ===========================================================================
  # Portal Frontend
  # ===========================================================================
  portal-web:
    build:
      context: ./portal/frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=https://${DOMAIN:-localhost}/api
        - VITE_DOMAIN=${DOMAIN:-localhost}
        - VITE_PORT=${PORT:-443}
    container_name: kanban-portal-web
    restart: unless-stopped
    networks:
      - kanban-global
    labels:
      - "traefik.enable=true"
      # HTTPS router
      - "traefik.http.routers.portal-web.rule=Host(`${DOMAIN:-localhost}`) && !PathPrefix(`/api`)"
      - "traefik.http.routers.portal-web.entrypoints=websecure"
      - "traefik.http.routers.portal-web.tls=true"
      - "traefik.http.routers.portal-web.tls.certresolver=letsencrypt"
      - "traefik.http.services.portal-web.loadbalancer.server.port=80"
      # HTTP router (redirect to HTTPS)
      - "traefik.http.routers.portal-web-http.rule=Host(`${DOMAIN:-localhost}`) && !PathPrefix(`/api`)"
      - "traefik.http.routers.portal-web-http.entrypoints=web"
      - "traefik.http.routers.portal-web-http.middlewares=redirect-to-https@file"

  # ===========================================================================
  # Background Worker (Task Processing)
  # ===========================================================================
  worker:
    build:
      context: ./portal/backend
      dockerfile: Dockerfile
    container_name: kanban-worker
    restart: unless-stopped
    command: python -m app.worker
    environment:
      - REDIS_URL=redis://redis:6379
      - DOMAIN=${DOMAIN:-localhost}
      - CERT_MODE=${CERT_MODE:-development}
      - AZURE_KEY_VAULT_URL=${AZURE_KEY_VAULT_URL}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
    volumes:
      - ./portal/backend/app:/app/app
      - ./data/portal:/app/data  # Same database as portal-api
      - ./traefik/certs:/app/certs
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - kanban-global
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r = redis.from_url('redis://redis:6379'); r.ping()"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    depends_on:
      redis:
        condition: service_healthy

  # ===========================================================================
  # Orchestrator (Team Provisioning)
  # ===========================================================================
  orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: kanban-orchestrator
    restart: unless-stopped
    environment:
      - REDIS_URL=redis://redis:6379
      - DOMAIN=${DOMAIN:-localhost}
      - PORT=${PORT:-4443}
      - CERT_MODE=${CERT_MODE:-development}
      - HOST_IP=${HOST_IP:-127.0.0.1}
      - HOST_PROJECT_PATH=${HOST_PROJECT_PATH:-/Volumes/dados/projects/kanban}
      # Email configuration (passed through to team containers)
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-office365}
      - SMTP_HOST=${SMTP_HOST:-smtp.office365.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - EMAIL_FROM_EMAIL=${EMAIL_FROM_EMAIL:-}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-Kanban}
    volumes:
      - ./orchestrator/app:/app/app
      - ./data/teams:/app/data/teams
      - ./kanban-team:/app/kanban-team:ro
      - ./traefik/certs:/app/certs
      - ./traefik/dynamic:/app/traefik-dynamic
      - ./coredns/zones:/app/dns-zones
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - kanban-global
    depends_on:
      redis:
        condition: service_healthy

  # ===========================================================================
  # Certificate Manager
  # ===========================================================================
  certbot:
    build:
      context: ./certbot
      dockerfile: Dockerfile
    container_name: kanban-certbot
    restart: unless-stopped
    environment:
      - CERT_MODE=${CERT_MODE:-development}
      - DOMAIN=${DOMAIN:-localhost}
      - CERTBOT_EMAIL=${CERTBOT_EMAIL:-admin@localhost}
    volumes:
      - ./traefik/certs:/etc/letsencrypt
      - ./certbot/webroot:/var/www/certbot
      - ./certbot/scripts:/scripts:ro
    networks:
      - kanban-global

  # ===========================================================================
  # Team Instances (dynamically provisioned by orchestrator)
  # ===========================================================================
  # Teams are created via the portal and provisioned automatically.
  # Each team gets: team-{slug}-api and team-{slug}-web services

  # ===========================================================================
  # DNS Server (Local Development)
  # ===========================================================================
  coredns:
    build:
      context: ./coredns
      dockerfile: Dockerfile
    container_name: kanban-coredns
    restart: unless-stopped
    ports:
      - "53:53/udp"
      - "53:53/tcp"
    volumes:
      - ./coredns/Corefile:/etc/coredns/Corefile:ro
      - ./coredns/zones:/etc/coredns/zones:ro
    networks:
      - kanban-global
    profiles:
      - dns  # Only start with: docker compose --profile dns up

# ===========================================================================
  # Kanban Agents - AI-powered task automation
  # ===========================================================================
  kanban-agents:
    build:
      context: ./kanban-agents
      dockerfile: Dockerfile
    container_name: kanban-project-agents
    restart: unless-stopped
    expose:
      - "8001"
    volumes:
      # Mount the kanban project as the target
      - .:/app/target-project:rw
      # Mount kanban-agents config
      - ./kanban-agents/config:/app/config:ro
      # Mount Claude CLI credentials (rw needed for project cache)
      - ${HOME}/.claude:/root/.claude:rw
      # Mount SSH key for host command execution
      - ${HOME}/.ssh/docker_to_mac:/root/.ssh/id_ed25519:ro
    environment:
      # Kanban API settings
      - KANBAN_API_URL=https://kanban-team.kanban.amazing-ai.tools/api
      - KANBAN_WEBHOOK_SECRET=${KANBAN_AGENTS_WEBHOOK_SECRET:-}
      # LLM settings (ollama, anthropic, openai, claude-cli)
      - LLM_PROVIDER=${LLM_PROVIDER:-anthropic}
      - LLM_MODEL=${LLM_MODEL:-claude-sonnet-4-20250514}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-4096}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      # API keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # Target project path inside container
      - TARGET_PROJECT_PATH=/app/target-project
      # SSH settings for host command execution
      - SSH_ENABLED=${SSH_ENABLED:-true}
      - SSH_HOST=${SSH_HOST:-host.docker.internal}
      - SSH_PORT=${SSH_PORT:-22}
      - SSH_USER=${SSH_USER:-hckmseduardo}
      - SSH_KEY_PATH=/root/.ssh/id_ed25519
      - SSH_HOST_PROJECT_PATH=${SSH_HOST_PROJECT_PATH:-/Volumes/dados/projects/kanban}
      # Server settings
      - HOST=0.0.0.0
      - PORT=8001
      - DEBUG=${DEBUG:-false}
    networks:
      - kanban-global
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      redis:
        condition: service_healthy

# =============================================================================
# Networks
# =============================================================================
networks:
  kanban-global:
    name: kanban-global
    driver: bridge
  proxy-network:
    external: true

# =============================================================================
# Volumes
# =============================================================================
volumes:
  redis_data:
    name: kanban-redis-data
